<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rally "O Alvo" - Cálculo de Pontuação</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Roboto:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Cores Inspiradas em Juventude Cristã - Refinado */
            --primary-blue: #004AAD; /* Azul principal, profundo e vibrante */
            --secondary-blue: #007BFF; /* Azul mais claro, para botões/detalhes */
            --dark-blue: #003366; /* Azul muito escuro, para cabeçalhos fortes/rodapés */
            --white: #FFFFFF;
            --light-gray: #F2F4F7; /* Fundo sutil */
            --medium-gray: #E0E4EB; /* Bordas, separadores */
            --text-dark: #333333;
            --text-light: #666666;
            --accent-yellow: #FFC107; /* Para rank ouro, destaques */
            --accent-green: #28A745;
            --danger-red: #DC3545;

            /* Mapeamento de variáveis existentes para a paleta */
            --main-color: var(--secondary-blue); /* Usado para títulos de seção, etc */
            --success-color: var(--accent-green); /* Verde para sucesso/ações secundárias */
            --header-bg: var(--primary-blue); /* Fundo do cabeçalho principal */
            --rank-gold: var(--accent-yellow);
            --rank-silver: #adb5bd;
            --rank-bronze: #fd7e14;
            --button-hover-color: #0056b3; /* Azul secundário mais escuro para hover */
            --info-color: #17a2b8; /* Uma cor de informação distinta */
        }

        body {
            font-family: 'Open Sans', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-gray);
            color: var(--text-dark);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            align-items: center;
        }

        .container {
            max-width: 950px;
            width: 100%;
            margin: 20px auto;
            background-color: var(--white);
            padding: 35px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease-in-out;
            position: relative;
            flex-grow: 1;
        }

        h1 {
            font-family: 'Roboto', sans-serif;
            color: var(--primary-blue);
            text-align: center;
            margin-bottom: 30px;
            font-weight: 700;
            font-size: 3em; /* Base para desktop */
            border-bottom: 4px solid var(--medium-gray);
            padding-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .reset-btn-bottom-right {
            background-color: var(--danger-red);
            color: var(--white);
            padding: 8px 15px;
            font-size: 0.85em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, opacity 0.3s ease;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.7;
        }
        .reset-btn-bottom-right:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            opacity: 1;
        }

        h2 {
            font-family: 'Roboto', sans-serif;
            color: var(--primary-blue);
            text-align: center;
            margin-top: 40px;
            margin-bottom: 25px;
            font-weight: 700;
            font-size: 2.2em; /* Base para desktop */
        }

        .mission, .tribe-scoring-section {
            background-color: var(--white);
            border: 1px solid var(--medium-gray);
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .mission h2 {
            background-color: var(--dark-blue);
            color: var(--white);
            padding: 15px 25px;
            margin: -30px -30px 25px -30px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            font-size: 1.8em; /* Base para desktop */
            text-align: left;
            font-weight: 600;
        }

        label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 1.05em; /* Base para desktop */
        }

        input[type="number"],
        input[type="checkbox"],
        select {
            padding: 14px;
            border: 1px solid var(--medium-gray);
            border-radius: 8px;
            font-size: 1.1em; /* Base para desktop */
            width: 100%;
            max-width: 250px; /* Limite em telas grandes */
            text-align: center;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="number"]:focus,
        select:focus {
            border-color: var(--secondary-blue);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: none;
        }

        input[type="checkbox"] {
            width: auto;
            transform: scale(1.4);
            margin-right: 10px;
            vertical-align: middle;
            accent-color: var(--secondary-blue);
        }

        p {
            margin-top: 15px;
            color: var(--text-light);
            font-size: 1.05em; /* Base para desktop */
        }

        .button-group {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            justify-content: center;
            flex-wrap: wrap; /* Permite que os botões quebrem a linha */
        }

        .button-group button {
            padding: 16px 35px;
            font-size: 1.2em; /* Base para desktop */
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .button-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .button-group .info-btn {
            background-color: var(--white);
            color: var(--secondary-blue);
            border: 2px solid var(--secondary-blue);
        }
        .button-group .info-btn:hover {
            background-color: var(--secondary-blue);
            color: var(--white);
        }

        .button-group .primary-btn {
            background-color: var(--secondary-blue);
            color: var(--white);
        }

        .button-group .primary-btn:hover {
            background-color: var(--button-hover-color);
        }

        .button-group .danger-btn {
            background-color: var(--danger-red);
            color: var(--white);
        }

        .button-group .danger-btn:hover {
            background-color: #c82333;
        }

        .button-group .secondary-btn {
            background-color: var(--accent-green);
            color: var(--white);
        }
        .button-group .secondary-btn:hover {
            background-color: #218838;
        }

        .hidden {
            display: none !important;
        }

        .total-section {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-top: 40px;
            justify-content: center;
        }

        .total, .tribe-total, .ranking, #leaderDisplay {
            flex: 1;
            /* Removendo min-width para permitir maior flexibilidade em telas pequenas */
            /* min-width: 280px; */
            background-color: var(--primary-blue);
            color: var(--white);
            padding: 35px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
        }

        .tribe-total {
            background-color: var(--secondary-blue);
        }

        .total h2, .tribe-total h2, .ranking h2 {
            font-family: 'Roboto', sans-serif;
            color: var(--white);
            margin: 0;
            font-size: 2.2em; /* Base para desktop */
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .tribe-icon {
            width: 40px;
            height: 40px;
            vertical-align: middle;
            border-radius: 50%;
            object-fit: cover;
        }

        #dailyBaseDisplay, .tribe-score {
            font-size: 3.2em; /* Base para desktop */
            font-weight: 900;
            display: block;
            margin-top: 18px;
            color: var(--white);
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        }

        #leaderDisplay {
            background-color: var(--dark-blue);
            color: var(--white);
            padding: 35px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
            text-align: center;
        }
        #leaderDisplay h2 {
            color: var(--white);
            font-size: 2.2em; /* Base para desktop */
            margin-bottom: 0;
            display: block;
            align-items: unset;
            justify-content: unset;
            gap: unset;
        }

        #leaderName {
            font-size: 3.5em; /* Base para desktop */
            font-weight: 900;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            color: var(--accent-yellow);
            text-shadow: 3px 3px 8px rgba(0, 0, 0, 0.7);
            animation: bounceIn 1s ease-out;
            width: 100%;
        }
        #leaderName .leader-icon {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent-yellow);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        #leaderName .leader-text {
            display: block;
            color: var(--accent-yellow);
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        .ranking {
            background-color: var(--dark-blue);
            text-align: left;
            padding: 30px;
        }

        .ranking h2 {
            text-align: center;
            margin-bottom: 25px;
        }

        .ranking ol {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ranking li {
            font-size: 1.3em; /* Base para desktop */
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            color: var(--white);
            font-weight: 400;
        }

        .ranking li:last-child {
            border-bottom: none;
        }

        .ranking li .trophy {
            font-size: 2em; /* Base para desktop */
            line-height: 1;
        }
        .ranking li .tribe-rank-name-group {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            flex-grow: 1;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }
        .ranking li .tribe-rank-name-group .tribe-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }

        .ranking li .tribe-rank-score {
            font-weight: 700;
            font-size: 1.5em; /* Base para desktop */
            color: var(--white);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .ranking li:nth-child(1) .tribe-rank-name-group .tribe-name-text { color: var(--rank-gold); }
        .ranking li:nth-child(2) .tribe-rank-name-group .tribe-name-text { color: var(--rank-silver); }
        .ranking li:nth-child(3) .tribe-rank-name-group .tribe-name-text { color: var(--rank-bronze); }

        #regulation-section {
            background-color: var(--white);
            border: 1px solid var(--medium-gray);
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            max-height: 75vh;
            overflow-y: auto;
            color: var(--text-dark);
        }

        #regulation-section h2 {
            color: var(--primary-blue);
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 2.5em; /* Base para desktop */
        }

        #regulation-section h3 {
            color: var(--secondary-blue);
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 2em; /* Base para desktop */
            font-weight: 600;
        }

        #regulation-section h4 {
            color: var(--accent-green);
            margin-top: 25px;
            margin-bottom: 12px;
            font-size: 1.6em; /* Base para desktop */
            font-weight: 600;
        }

        #regulation-section ul {
            list-style: disc;
            margin-left: 30px;
            margin-bottom: 15px;
            font-size: 1.05em; /* Base para desktop */
        }

        #regulation-section li {
            margin-bottom: 8px;
            color: var(--text-light);
        }

        #regulation-section p {
            margin-bottom: 15px;
            color: var(--text-light);
            font-size: 1.05em; /* Base para desktop */
        }
        #regulation-section hr {
            border: 0;
            height: 1px;
            background: var(--medium-gray);
            margin: 30px 0;
        }

        #championAnimation {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 51, 102, 0.98);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            overflow: hidden;
            animation: fadeIn 0.8s ease-out forwards;
            backdrop-filter: blur(5px);
        }

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        .confetti {
            position: absolute;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            opacity: 0;
            animation: confettiFall 5s infinite ease-out;
        }

        @keyframes confettiFall {
            0% {
                opacity: 0;
                transform: translate(var(--random-x), -100px) rotate(0deg);
            }
            10% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translate(var(--random-x), 110vh) rotate(1080deg);
            }
        }

        #championTitle {
            font-family: 'Roboto', sans-serif;
            font-size: 5em; /* Base para desktop */
            color: var(--accent-yellow);
            font-weight: 900;
            margin-bottom: 30px;
            text-shadow: 6px 6px 15px rgba(0, 0, 0, 0.9);
            animation: pulse 1.5s infinite alternate, glow 1s infinite alternate;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.9; }
            100% { transform: scale(1.1); opacity: 1; }
        }
        @keyframes glow {
            from { text-shadow: 0 0 10px var(--accent-yellow), 0 0 20px var(--accent-yellow); }
            to { text-shadow: 0 0 20px var(--accent-yellow), 0 0 30px var(--accent-yellow), 0 0 40px var(--accent-yellow); }
        }

        #championNameAnimated {
            font-family: 'Roboto', sans-serif;
            font-size: 7em; /* Base para desktop */
            color: var(--white);
            font-weight: 900;
            text-shadow: 8px 8px 18px rgba(0, 0, 0, 0.95);
            animation: slideIn 1.5s ease-out forwards, colorChange 3s infinite alternate;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        #championNameAnimated .tribe-icon {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid var(--accent-yellow);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        /* --- Media Queries para Responsividade --- */

        /* Tablets e Telas Maiores (até 992px de largura) */
        @media (max-width: 992px) {
            .container {
                padding: 30px;
            }
            h1 {
                font-size: 2.5em; /* Ajuste para tablets */
            }
            h2 {
                font-size: 2em; /* Ajuste para tablets */
            }
            .mission h2 {
                font-size: 1.6em; /* Ajuste para tablets */
            }
            #championTitle {
                font-size: 4em; /* Ajuste para tablets */
            }
            #championNameAnimated {
                font-size: 6em; /* Ajuste para tablets */
            }
            .reset-btn-bottom-right {
                bottom: 10px;
                right: 10px;
                padding: 6px 12px;
                font-size: 0.8em;
            }
            /* Garantir que inputs e selects ocupem a largura total em telas menores */
            input[type="number"], select {
                max-width: 100%;
            }
        }

        /* Celulares (até 768px de largura) */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            .container {
                padding: 25px;
                margin: 15px auto;
            }
            /* Total Section: Pilhar elementos verticalmente */
            .total-section {
                flex-direction: column;
                gap: 20px;
            }
            .total, .tribe-total, .ranking, #leaderDisplay {
                /* Remover min-width e deixar flex: 1 lidar com a largura */
                min-width: unset; 
                padding: 25px;
            }
            /* Button Group: Pilhar botões verticalmente */
            .button-group {
                flex-direction: column;
                gap: 12px;
            }
            input[type="number"], select {
                max-width: 100%;
                padding: 12px;
            }
            h1 {
                font-size: 2.2em; /* Ajuste para celulares */
                padding-bottom: 15px;
            }
            h2 {
                font-size: 1.8em; /* Ajuste para celulares */
                margin-top: 30px;
                margin-bottom: 20px;
            }
            .mission h2 {
                font-size: 1.4em; /* Ajuste para celulares */
                padding: 12px 20px;
                margin: -25px -25px 20px -25px;
            }
            label {
                font-size: 1em; /* Ajuste para celulares */
            }
            p {
                font-size: 0.95em; /* Ajuste para celulares */
            }
            .button-group button {
                padding: 14px 28px;
                font-size: 1.1em; /* Ajuste para celulares */
            }
            #dailyBaseDisplay, .tribe-score {
                font-size: 2.8em; /* Ajuste para celulares */
            }
            #leaderName {
                font-size: 3em; /* Ajuste para celulares */
            }
            #leaderName .leader-icon {
                width: 80px;
                height: 80px;
                border-width: 2px;
            }
            .ranking li {
                font-size: 1.2em; /* Ajuste para celulares */
                padding: 10px 0;
            }
            .ranking li .trophy {
                font-size: 1.8em; /* Ajuste para celulares */
            }
            .ranking li .tribe-rank-score {
                font-size: 1.4em; /* Ajuste para celulares */
            }
            #championTitle {
                font-size: 3.5em; /* Ajuste para celulares */
            }
            #championNameAnimated {
                font-size: 5em; /* Ajuste para celulares */
            }
            #championNameAnimated .tribe-icon {
                width: 100px;
                height: 100px;
                border-width: 4px;
            }
            #regulation-section {
                padding: 20px;
            }
            #regulation-section h3 {
                font-size: 1.7em; /* Ajuste para celulares */
            }
            #regulation-section h4 {
                font-size: 1.3em; /* Ajuste para celulares */
            }
            .reset-btn-bottom-right {
                bottom: 5px;
                right: 5px;
                padding: 4px 8px;
                font-size: 0.7em;
            }

            /* Histórico: Fazer a tabela ter scroll horizontal em telas pequenas */
            #history-section table {
                display: block; /* Permite scroll horizontal */
                overflow-x: auto; /* Adiciona barra de rolagem horizontal */
                white-space: nowrap; /* Impede que o conteúdo da célula quebre */
            }
            #history-section thead, #history-section tbody, #history-section tfoot,
            #history-section th, #history-section td, #history-section tr {
                display: table-cell; /* Força comportamento de célula de tabela */
                white-space: nowrap; /* Previne quebra de linha em células */
            }
            #history-section tr {
                display: table-row;
            }
        }

        /* Estilos para a Seção de Histórico */
        #history-section table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.95em;
        }

        #history-section th, #history-section td {
            border: 1px solid var(--medium-gray);
            padding: 10px;
            text-align: center;
        }

        #history-section th {
            background-color: var(--secondary-blue);
            color: var(--white);
            font-weight: 600;
        }

        #history-section tr:nth-child(even) {
            background-color: var(--light-gray);
        }

        #history-section .history-total-row {
            background-color: var(--primary-blue);
            color: var(--white);
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Rally "O Alvo" - Cálculo de Pontuação</h1>

    <div class="button-group">
        <button class="info-btn" onclick="toggleRegulation()">Ver Regulamento</button>
        <button class="primary-btn" onclick="toggleHistory()">Histórico Semanal</button>
        <button class="secondary-btn" onclick="toggleChampionAnimation()">Ver Campeão Final</button>
        <button class="danger-btn" onclick="confirmEndWeek()">Finalizar Semana e Salvar Totais</button>
    </div>

    <div id="regulation-section" class="hidden">
        <h2>Regulamento do Rally "O Alvo"</h2>
        <hr>
        <h3>📌 Mecânica do Jogo:</h3>
        <ul>
            <li>As tribos (equipes) acumulam 🎯 **ALVOS (pontos)** ao cumprirem missões.</li>
            <li>Missões **SEMANAIS** têm valores diferentes.</li>
            <li>Missões especiais dão bônus maiores.</li>
        </ul>

        <h3>📅 Missões Semanais (06 a 12 de Julho)</h3>

        <h4>📍 SEGUNDA-FEIRA</h4>
        <p>🅰️➕ **ALGO A MAIS**</p>
        <ul>
            <li>Cada jovem presente na reunião = **50 🎯**</li>
            <li>Enviar 1 foto da reunião no grupo até 22h.</li>
        </ul>

        <h4>📍 TERÇA-FEIRA</h4>
        <p>🦶🏘 **PÉ NO BAIRRO** (Evangelismo)</p>
        <ul>
            <li>**100 🎯** por trabalho realizado (mínimo 3 jovens da tribo).</li>
            <li>Enviar 1 foto (câmera deitada) com jornal/folheto da semana.</li>
        </ul>

        <h4>📍 QUARTA-FEIRA</h4>
        <p>📖🇨🇷 **SALVAÇÃO DA ALMA**</p>
        <ul>
            <li>Jovens nas reuniões (outros horários) = **30 🎯** cada</li>
            <li>Jovens na reunião principal das 18h = **50 🎯** cada</li>
        </ul>

        <h4>📍 QUINTA-FEIRA</h4>
        <p>❤️‍🔥🇨🇷 **TERAPIA DO AMOR** (Reunião Principal)</p>
        <ul>
            <li>**50 🎯** por jovem presente às 19h.</li>
        </ul>

        <h4>📍 SÁBADO</h4>
        <p>📻🇨🇷 **CONEXÃO JOVEM**</p>
        <ul>
            <li>**20 🎯** por jovem conectado (**11h30**).</li>
            <li>FOTO NO GRUPO para comprovar.</li>
        </ul>
        <p>🎯 **ENCONTRO JOVEM** (EJ)</p>
        <ul>
            <li>**100 🎯** por jovem novo (que nunca foi ao EJ).</li>
            <li>**60 🎯** por jovem afastado que retornar.</li>
        </ul>

        <h4>📍 DOMINGO</h4>
        <p>⛪️🇨🇷 **CONCENTRAÇÃO DE FÉ**</p>
        <ul>
            <li>**150 🎯** por jovem presente 9H30.</li>
            <li>**75 🎯** por jovem presente 9H30.</li>
            <li>FOTO NO GRUPO para comprovar.</li>
        </ul>

        <hr>

        <h3>🔥 Missões Especiais (Bônus Alto!)</h3>

        <h4>📍 Ponto de Oração</h4>
        <ul>
            <li>**300 🎯** por tribo que organizar um momento de oração durante a semana.</li>
        </ul>

        <h4>📍 Evangelização Criativa</h4>
        <ul>
            <li>**1.000 🎯** para a tribo que fizer uma ação evangelística inovadora (entregas de livros, algo criativo!).</li>
            <li>FOTO NO GRUPO para comprovar.</li>
        </ul>

        <h4>🌳 Desafio dos Alvos</h4>
        <ul>
            <li>**2.000 🎯** – Montar um time de futebol (mínimo **5 jogadores**). Trazer no encontro.</li>
            <li>**700 🎯** – Doar 1 resma de papel A4.</li>
            <li>**1.000 🎯** – Melhor foto da tribo (dentro ou fora da igreja).</li>
        </ul>

        <h4>🧽🪣 Manutenção do Templo</h4>
        <ul>
            <li>**200 🎯** por jovem que ajudar na limpeza/organização no Sábado (**8h30**).</li>
        </ul>

        <hr>

        <h3>⚡️ Missões Surpresa</h3>
        <ul>
            <li>O líder pode lançar desafios-relâmpago a qualquer momento!</li>
            <li>Valores de 🎯 **ALVOS** serão definidos na hora.</li>
        </ul>

        <hr>
        <h3>🏆 Meta da Tribo</h3>
        <ul>
            <li>1ª Semana: Trazer 20 jovens (vale **10.000 pontos**).</li>
        </ul>

        <hr>
        <h3>🎯 Objetivo Final:</h3>
        <p>Manter o foco no Alvo Maior (Cristo) enquanto os jovens se divertem, competem e fortalecem sua comunhão!</p>
        <p><em>"Prossigo para o alvo, para o prêmio da soberana vocação de Deus em Cristo Jesus."</em> (Filipenses 3:14)</p>
        <div class="button-group">
            <button class="primary-btn" onclick="showDailyMissions()">Voltar ao Calculador</button>
        </div>
    </div>

    <div id="daily-missions-section">
        <div class="mission">
            <h2>Semana Atual: <span id="current-week-display">1</span></h2>
            <label for="week-selector">Mudar para Semana:</label>
            <select id="week-selector" onchange="confirmChangeWeek()"></select>
        </div>

        <h2>Pontuação Base Diária das Missões</h2>
        <div class="mission">
            <h2>Segunda-feira - Algo a Mais</h2>
            <label for="segunda">Jovens presentes:</label>
            <input type="number" id="segunda" value="0" oninput="calculateDailyBase('segunda')" min="0">
            <p>Pontos: 50 cada</p>
        </div>

        <div class="mission">
            <h2>Terça-feira - Pé no Bairro</h2>
            <label for="terca">Trabalhos realizados (mínimo 3 jovens):</label>
            <input type="number" id="terca" value="0" oninput="calculateDailyBase('terca')" min="0">
            <p>Pontos: 100 cada</p>
        </div>

        <div class="mission">
            <h2>Quarta-feira - Salvação da Alma</h2>
            <label for="quarta_outros">Jovens em outros horários:</label>
            <input type="number" id="quarta_outros" value="0" oninput="calculateDailyBase('quarta_outros')" min="0">
            <p>Pontos: 30 cada</p>
            <label for="quarta_principal">Jovens na reunião principal (18h):</label>
            <input type="number" id="quarta_principal" value="0" oninput="calculateDailyBase('quarta_principal')" min="0">
            <p>Pontos: 50 cada</p>
        </div>

        <div class="mission">
            <h2>Quinta-feira - Terapia do Amor</h2>
            <label for="quinta">Jovens presentes:</label>
            <input type="number" id="quinta" value="0" oninput="calculateDailyBase('quinta')" min="0">
            <p>Pontos: 50 cada</p>
        </div>

        <h2>Sábado - Missões</h2>
        <div class="mission">
            <h2>Conexão Jovem</h2>
            <label for="sabado">Jovens conectados (11h30):</label>
            <input type="number" id="sabado" value="0" oninput="calculateDailyBase('sabado')" min="0">
            <p>Pontos: 20 cada</p>
        </div>

        <div class="mission">
            <h2>Encontro Jovem (EJ)</h2>
            <label for="ej_novo">Jovens novos que nunca foram ao EJ:</label>
            <input type="number" id="ej_novo" value="0" oninput="calculateDailyBase('ej_novo')" min="0">
            <p>Pontos: 100 cada</p>

            <label for="ej_afastado">Jovens afastados que retornaram ao EJ:</label>
            <input type="number" id="ej_afastado" value="0" oninput="calculateDailyBase('ej_afastado')" min="0">
            <p>Pontos: 60 cada</p>
        </div>

        <div class="mission">
            <h2>Domingo - Concentração de Fé</h2>
            <label for="domingo_150">Jovens presentes (150pts):</label>
            <input type="number" id="domingo_150" value="0" oninput="calculateDailyBase('domingo_150')" min="0">
            <p>Pontos: 150 cada</p>
            <label for="domingo_75">Jovens presentes (75pts):</label>
            <input type="number" id="domingo_75" value="0" oninput="calculateDailyBase('domingo_75')" min="0">
            <p>Pontos: 75 cada</p>
        </div>

        <h2>Desafios Extras / Bônus</h2>

        <div class="mission">
            <h2>Manutenção do Templo</h2>
            <label for="manutencao_templo">Jovens que ajudaram:</label>
            <input type="number" id="manutencao_templo" value="0" oninput="calculateDailyBase('manutencao_templo')" min="0">
            <p>Pontos: 200 cada jovem</p>
        </div>

        <div class="mission">
            <h2>Doação de Resma de Papel A4</h2>
            <label for="resma_papel">Quantidade de resmas (se cumpriu, digite 1):</label>
            <input type="number" id="resma_papel" value="0" oninput="calculateDailyBase('resma_papel')" min="0">
            <p>Pontos: 700</p>
        </div>

        <div class="mission">
            <h2>Montar Time de Futebol</h2>
            <label for="time_futebol">Cumpriu o desafio? (digite 1):</label>
            <input type="number" id="time_futebol" value="0" oninput="calculateDailyBase('time_futebol')" min="0">
            <p>Pontos: 2.000</p>
        </div>

        <div class="mission">
            <h2>Evangelização Criativa</h2>
            <label for="evangelizacao_criativa">Cumpriu o desafio? (digite 1):</label>
            <input type="number" id="evangelizacao_criativa" value="0" oninput="calculateDailyBase('evangelizacao_criativa')" min="0">
            <p>Pontos: 1.000</p>
        </div>

        <div class="mission">
            <h2>Ponto de Oração</h2>
            <label for="ponto_oracao">Cumpriu o desafio? (digite 1):</label>
            <input type="number" id="ponto_oracao" value="0" oninput="calculateDailyBase('ponto_oracao')" min="0">
            <p>Pontos: 300</p>
        </div>


        <div class="total">
            <h2>Pontuação Base Diária (para ser atribuída): <span id="dailyBaseDisplay">0</span></h2>
        </div>

        <div class="button-group">
            <button class="primary-btn" onclick="showTribeSelection()">Atribuir Pontuação para Tribo</button>
        </div>
    </div>

    <div id="tribe-scoring-section" class="tribe-scoring-section hidden">
        <h2>Atribuir Pontuação à Tribo</h2>
        <p>Pontuação Base Atual das Missões: <strong id="currentDailyBase">0</strong></p>

        <label for="tribe-selector">Selecione a Tribo:</label>
        <select id="tribe-selector" onchange="loadTribePoints()">
            <option value="">-- Selecione --</option>
        </select>

        <div id="selected-tribe-inputs" class="hidden">
            <h3><img id="selected-tribe-icon" class="tribe-icon" alt="Ícone da Tribo Selecionada"><span id="selected-tribe-name"></span></h3>
            <label for="tribe_current_base">Pontos Base das Missões (preenchido automaticamente):</label>
            <input type="number" id="tribe_current_base" value="0" disabled>

            <label for="tribe_bonus">Bônus da Tribo (Missões Especiais):</label>
            <input type="number" id="tribe_bonus" value="0" min="0">

            <label for="tribe_total_manual">Total Manual (Opcional, para Missões Surpresa ou ajuste):</label>
            <input type="number" id="tribe_total_manual" value="0" min="0">

            <div class="button-group">
                <button class="primary-btn" onclick="saveTribePoints()">Salvar Pontuação da Tribo</button>
                <button class="danger-btn" onclick="clearSelectedTribeInputs()">Limpar Seleção</button>
            </div>
        </div>

        <div class="button-group">
            <button class="primary-btn" onclick="showDailyMissions()">Voltar para Missões Diárias</button>
        </div>
    </div>

    <div id="history-section" class="hidden container">
        <h2>Histórico de Pontuação Semanal</h2>
        <p>Acompanhe a evolução de cada tribo semana a semana. O campeão será a tribo com a maior pontuação acumulada!</p>
        <table id="history-table">
            <thead>
                <tr>
                    <th>Tribo</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
            <tfoot>
                <tr class="history-total-row">
                    <td>TOTAL GERAL</td>
                </tr>
            </tfoot>
        </table>
        <div class="button-group">
            <button class="primary-btn" onclick="showDailyMissions()">Voltar ao Calculador</button>
        </div>
    </div>

    <hr>
    <div class="total-section">
        <div class="tribe-total">
            <h2><img src="Levi.png" alt="Logo Levi" class="tribe-icon"> Tribo de Levi</h2>
            <span class="tribe-score" id="score_levi">0</span>
        </div>

        <div class="tribe-total">
            <h2><img src="Juda.png" alt="Logo Judá" class="tribe-icon"> Tribo de Judá</h2>
            <span class="tribe-score" id="score_juda">0</span>
        </div>

        <div class="tribe-total">
            <h2><img src="Naftali.png" alt="Logo Naftali" class="tribe-icon"> Tribo de Naftali</h2>
            <span class="tribe-score" id="score_naftali">0</span>
        </div>

        <div class="tribe-total">
            <h2><img src="Gade.png" alt="Logo Gade" class="tribe-icon"> Tribo de Gade</h2>
            <span class="tribe-score" id="score_gade">0</span>
        </div>

        <div class="ranking">
            <h2>Classificação das Tribos (Total)</h2>
            <ol id="tribes_ranking"></ol>
        </div>

        <div id="leaderDisplay">
            <h2>Líder Atual:</h2>
            <span id="leaderName"><span class="leader-text">Nenhuma tribo pontuada</span></span>
        </div>
    </div>

    <div id="championAnimation">
        <h2 id="championTitle">🏆 CAMPEÃO 🏆</h2>
        <div id="championNameAnimated"></div>
    </div>
</div>

<footer>
    <p>&copy; 2025 Rally "O Alvo" - Grupo Jovem.</p>
    <button class="reset-btn-bottom-right" onclick="confirmResetAllData()">Reiniciar Rally</button>
</footer>

<script>
    // --- IMPORTANTE: SUBSTITUA ESTE LINK PELO SEU URL REAL DO GOOGLE APPS SCRIPT ---
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbySyI_JZG35dsK-xHDOMt3fXm-7GxL16C83b5amJvG8TZZ5xg_AhbHbj-8P9i9SmB9OFg/exec'; // SEU URL REAL AQUI!

    const TOTAL_WEEKS = 9; // Número total de semanas do Rally

    let dailyBasePoints = 0; // Pontuação base calculada das missões diárias
    let currentWeekNumber = 1; // Semana atual, começa na 1

    // Objeto para armazenar as pontuações e o histórico semanal
    const tribes = {
        levi: { weeklyScores: Array(TOTAL_WEEKS).fill(0), nameDisplay: "Tribo de Levi", logo: "Levi.png" },
        juda: { weeklyScores: Array(TOTAL_WEEKS).fill(0), nameDisplay: "Tribo de Judá", logo: "Juda.png" },
        naftali: { weeklyScores: Array(TOTAL_WEEKS).fill(0), nameDisplay: "Tribo de Naftali", logo: "Naftali.png" },
        gade: { weeklyScores: Array(TOTAL_WEEKS).fill(0), nameDisplay: "Tribo de Gade", logo: "Gade.png" }
    };

    // Objeto para armazenar o estado de finalização de cada semana
    const weekStatus = Array(TOTAL_WEEKS).fill(false); // false = não finalizada, true = finalizada

    // Objeto para armazenar os valores dos inputs das missões diárias e extras
    const dailyMissionInputValues = {
        segunda: 0, terca: 0, quarta_outros: 0, quarta_principal: 0, quinta: 0,
        sabado: 0, ej_novo: 0, ej_afastado: 0, domingo_150: 0, domingo_75: 0,
        manutencao_templo: 0, resma_papel: 0, time_futebol: 0, evangelizacao_criativa: 0, ponto_oracao: 0
    };

    // Helper functions
    const getInputValue = (id) => parseInt(document.getElementById(id).value) || 0;

    // --- LocalStorage Functions ---
    function saveStateToLocalStorage() {
        localStorage.setItem('rallyTribesData', JSON.stringify(tribes));
        localStorage.setItem('rallyCurrentWeek', currentWeekNumber);
        localStorage.setItem('rallyWeekStatus', JSON.stringify(weekStatus)); // Salva o status das semanas
    }

    function loadStateFromLocalStorage() {
        const savedTribesData = localStorage.getItem('rallyTribesData');
        const savedWeek = localStorage.getItem('rallyCurrentWeek');
        const savedWeekStatus = localStorage.getItem('rallyWeekStatus');

        if (savedTribesData) {
            const loadedTribes = JSON.parse(savedTribesData);
            for (const tribeId in tribes) {
                if (loadedTribes[tribeId]) {
                    if (loadedTribes[tribeId].weeklyScores && loadedTribes[tribeId].weeklyScores.length === TOTAL_WEEKS) {
                        tribes[tribeId].weeklyScores = loadedTribes[tribeId].weeklyScores;
                    } else {
                        let newWeeklyScores = Array(TOTAL_WEEKS).fill(0);
                        if (loadedTribes[tribeId].weeklyScores) {
                            for (let i = 0; i < Math.min(loadedTribes[tribeId].weeklyScores.length, TOTAL_WEEKS); i++) {
                                newWeeklyScores[i] = loadedTribes[tribeId].weeklyScores[i];
                            }
                        }
                        tribes[tribeId].weeklyScores = newWeeklyScores;
                    }
                    tribes[tribeId].nameDisplay = loadedTribes[tribeId].nameDisplay || tribes[tribeId].nameDisplay;
                    tribes[tribeId].logo = loadedTribes[tribeId].logo || tribes[tribeId].logo;
                    // Removemos processedInCurrentRound do objeto tribes
                }
            }
        }
        if (savedWeek && parseInt(savedWeek) >= 1 && parseInt(savedWeek) <= TOTAL_WEEKS) {
            currentWeekNumber = parseInt(savedWeek);
        } else {
            currentWeekNumber = 1; // Default para semana 1 se não houver salvamento válido
        }

        if (savedWeekStatus) {
            const loadedStatus = JSON.parse(savedWeekStatus);
            for(let i = 0; i < TOTAL_WEEKS; i++) {
                if (typeof loadedStatus[i] === 'boolean') {
                    weekStatus[i] = loadedStatus[i];
                }
            }
        }
    }

    // --- Navigation Functions ---
    function hideAllSections() {
        document.getElementById('daily-missions-section').classList.add('hidden');
        document.getElementById('tribe-scoring-section').classList.add('hidden');
        document.getElementById('regulation-section').classList.add('hidden');
        document.getElementById('history-section').classList.add('hidden');
        document.getElementById('championAnimation').style.display = 'none';
        document.getElementById('leaderDisplay').style.display = 'block'; // Mostra o líder por padrão nas outras telas
    }

    function showDailyMissions() {
        hideAllSections();
        document.getElementById('daily-missions-section').classList.remove('hidden');
        resetDailyMissionInputs(); // Limpa os inputs diários ao voltar para esta seção
        updateWeekSelector();
        populateTribeSelector();
    }

    function toggleRegulation() {
        const regulationSection = document.getElementById('regulation-section');
        if (regulationSection.classList.contains('hidden')) {
            hideAllSections();
            regulationSection.classList.remove('hidden');
        } else {
            showDailyMissions();
        }
    }

    function toggleHistory() {
        const historySection = document.getElementById('history-section');
        if (historySection.classList.contains('hidden')) {
            hideAllSections();
            historySection.classList.remove('hidden');
            updateHistoryDisplay();
        } else {
            showDailyMissions();
        }
    }

    function toggleChampionAnimation() {
        const championAnimationDiv = document.getElementById('championAnimation');
        const leaderDisplay = document.getElementById('leaderDisplay');

        // VERIFICAÇÃO PRINCIPAL: Se a animação já estiver visível
        if (championAnimationDiv.style.display === 'flex') {
            // Se estiver visível, vamos esconder a animação e mostrar o menu principal
            championAnimationDiv.style.display = 'none'; // Esconde a animação
            leaderDisplay.style.display = 'block'; // Garante que o display do líder volte a aparecer
            showDailyMissions(); // Chama a função que exibe o menu principal (missões diárias)
        } else {
            // Se a animação NÃO estiver visível, vamos exibi-la
            const sortedTribes = Object.keys(tribes)
                .filter(key => Object.prototype.hasOwnProperty.call(tribes, key))
                .map(key => ({
                    name: tribes[key].nameDisplay,
                    score: tribes[key].weeklyScores.reduce((sum, score) => sum + score, 0),
                    id: key,
                    logo: tribes[key].logo
                }))
                .sort((a, b) => b.score - a.score);

            if (sortedTribes.length > 0 && sortedTribes[0].score > 0) {
                const championTribeName = sortedTribes[0].name;
                const championTribeLogo = sortedTribes[0].logo;

                hideAllSections(); // Primeiro, esconde todas as outras seções
                leaderDisplay.style.display = 'none'; // Esconde o display do líder, pois a animação vai aparecer
                championAnimationDiv.style.display = 'flex'; // Exibe a animação do campeão

                document.getElementById('championNameAnimated').innerHTML = `
                    <img src="${championTribeLogo}" alt="Logo Campeão" class="tribe-icon">
                    <span>${championTribeName}</span>
                `;

                // Remove confetes antigos e adiciona novos para a animação
                const existingConfetti = championAnimationDiv.querySelectorAll('.confetti');
                existingConfetti.forEach(confetti => confetti.remove());

                for (let i = 0; i < 100; i++) {
                    const confetti = document.createElement('div');
                    confetti.classList.add('confetti');
                    confetti.style.backgroundColor = getRandomColor();
                    confetti.style.setProperty('--random-x', `${Math.random() * 100}vw`);
                    confetti.style.animationDelay = `${Math.random() * 2}s`;
                    confetti.style.animationDuration = `${2 + Math.random() * 1}s`;
                    championAnimationDiv.appendChild(confetti);
                }
            } else {
                alert("Nenhuma tribo pontuada ainda para determinar um campeão! Lance os pontos das semanas para ver quem vence.");
                // Se não houver campeão, voltamos ao menu principal caso alguma outra seção esteja aberta
                showDailyMissions();
            }
        }
    }

    function showTribeSelection() {
        hideAllSections();
        document.getElementById('tribe-scoring-section').classList.remove('hidden');
        document.getElementById('currentDailyBase').innerText = dailyBasePoints;
        document.getElementById('selected-tribe-inputs').classList.add('hidden');
        populateTribeSelector();
    }

    // --- Week Management ---
    function updateWeekSelector() {
        const weekSelector = document.getElementById('week-selector');
        weekSelector.innerHTML = '';
        for (let i = 1; i <= TOTAL_WEEKS; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.innerText = `Semana ${i}`;
            weekSelector.appendChild(option);
        }
        weekSelector.value = currentWeekNumber;
        document.getElementById('current-week-display').innerText = currentWeekNumber;
        updateWeekSelectFiltering();
    }

    function updateWeekSelectFiltering() {
        const weekSelector = document.getElementById('week-selector');
        for (let i = 0; i < TOTAL_WEEKS; i++) {
            const weekOption = weekSelector.options[i];
            const weekIndex = i; // Índice da semana (0-based)
            const displayWeekNumber = i + 1; // Número da semana (1-based)

            if (weekOption) {
                // Se for a semana atual, ela nunca é desabilitada
                if (displayWeekNumber === currentWeekNumber) {
                    weekOption.disabled = false;
                    weekOption.innerText = `Semana ${displayWeekNumber}`;
                }
                // Se for uma semana futura, é desabilitada
                else if (displayWeekNumber > currentWeekNumber) {
                    weekOption.disabled = true;
                    weekOption.innerText = `Semana ${displayWeekNumber}`;
                }
                // Se for uma semana passada
                else if (displayWeekNumber < currentWeekNumber) {
                    if (weekStatus[weekIndex]) { // Se a semana anterior foi FINALIZADA
                        weekOption.disabled = true;
                        weekOption.innerText = `Semana ${displayWeekNumber} (Finalizada)`;
                    } else { // Se a semana anterior não foi finalizada, permite edição
                        weekOption.disabled = false;
                        weekOption.innerText = `Semana ${displayWeekNumber} (Não Finalizada)`;
                    }
                }
            }
        }
    }

    function confirmChangeWeek() {
        const newWeek = parseInt(document.getElementById('week-selector').value);
        if (newWeek !== currentWeekNumber) {
            // Se a nova semana for menor que a atual E a semana anterior foi finalizada, pede confirmação para reabrir
            if (newWeek < currentWeekNumber && weekStatus[newWeek - 1]) {
                const confirmReopen = confirm(`A Semana ${newWeek} foi finalizada. Tem certeza que deseja reabrí-la para edição? Isso permitirá alterar as pontuações desta semana.`);
                if (confirmReopen) {
                    // Reabre a semana, mas não avança automaticamente ao reabrir
                    currentWeekNumber = newWeek;
                    document.getElementById('current-week-display').innerText = currentWeekNumber;
                    resetDailyMissionInputs(); // Limpa os inputs diários
                    dailyBasePoints = 0;
                    document.getElementById('dailyBaseDisplay').innerText = 0;
                    saveStateToLocalStorage();
                    populateTribeSelector();
                    updateTribeDisplays();
                    updateRanking();
                    updateWeekSelectFiltering();
                    alert(`Semana ${newWeek} reaberta para edição.`);
                } else {
                    // Se cancelou, volta o seletor para a semana atual
                    document.getElementById('week-selector').value = currentWeekNumber;
                }
            } else {
                // Se a nova semana for maior, ou for uma semana anterior não finalizada, apenas troca
                currentWeekNumber = newWeek;
                document.getElementById('current-week-display').innerText = currentWeekNumber;
                resetDailyMissionInputs();
                dailyBasePoints = 0;
                document.getElementById('dailyBaseDisplay').innerText = 0;
                saveStateToLocalStorage();
                populateTribeSelector();
                updateTribeDisplays();
                updateRanking();
                updateWeekSelectFiltering();
            }
        }
    }

    // --- Calculate Daily Base Score ---
    function calculateDailyBase(inputName) {
        dailyMissionInputValues[inputName] = getInputValue(inputName);

        let total = 0;
        total += dailyMissionInputValues.segunda * 50;
        total += dailyMissionInputValues.terca * 100;
        total += dailyMissionInputValues.quarta_outros * 30;
        total += dailyMissionInputValues.quarta_principal * 50;
        total += dailyMissionInputValues.quinta * 50;
        total += dailyMissionInputValues.sabado * 20;
        total += dailyMissionInputValues.ej_novo * 100;
        total += dailyMissionInputValues.ej_afastado * 60;
        total += dailyMissionInputValues.domingo_150 * 150;
        total += dailyMissionInputValues.domingo_75 * 75;

        // Missões Extras
        total += dailyMissionInputValues.manutencao_templo * 200;
        total += dailyMissionInputValues.resma_papel * 700;
        total += dailyMissionInputValues.time_futebol * 2000;
        total += dailyMissionInputValues.evangelizacao_criativa * 1000;
        total += dailyMissionInputValues.ponto_oracao * 300;

        dailyBasePoints = total;
        document.getElementById('dailyBaseDisplay').innerText = dailyBasePoints;
    }

    // --- Manage Individual Tribe Scoring ---
    function populateTribeSelector() {
        const tribeSelector = document.getElementById('tribe-selector');
        tribeSelector.innerHTML = '<option value="">-- Selecione --</option>';
        // Agora, todas as tribos aparecem para seleção. A flag processedInCurrentRound é gerenciada por clique.
        for (const tribeId in tribes) {
            if (Object.prototype.hasOwnProperty.call(tribes, tribeId)) {
                const option = document.createElement('option');
                option.value = tribeId;
                option.innerText = tribes[tribeId].nameDisplay;
                tribeSelector.appendChild(option);
            }
        }
        tribeSelector.value = "";
        document.getElementById('selected-tribe-inputs').classList.add('hidden');
    }

    function loadTribePoints() {
        const selectedTribeId = document.getElementById('tribe-selector').value;
        const selectedTribeInputsDiv = document.getElementById('selected-tribe-inputs');
        const selectedTribeIcon = document.getElementById('selected-tribe-icon');

        if (selectedTribeId === "") {
            selectedTribeInputsDiv.classList.add('hidden');
            return;
        }

        selectedTribeInputsDiv.classList.remove('hidden');
        document.getElementById('selected-tribe-name').innerText = tribes[selectedTribeId].nameDisplay;
        selectedTribeIcon.src = tribes[selectedTribeId].logo;
        selectedTribeIcon.alt = `Logo ${tribes[selectedTribeId].nameDisplay}`;

        document.getElementById('tribe_current_base').value = dailyBasePoints;

        document.getElementById('tribe_bonus').value = 0;
        document.getElementById('tribe_total_manual').value = 0;
    }

    async function saveTribePoints() {
        const selectedTribeId = document.getElementById('tribe-selector').value;
        if (selectedTribeId === "") {
            alert("Por favor, selecione uma tribo antes de salvar!");
            return;
        }

        const currentBase = dailyBasePoints;
        const bonus = getInputValue('tribe_bonus');
        const manualTotal = getInputValue('tribe_total_manual');
        let pointsToAdd = 0;

        if (manualTotal > 0) {
            pointsToAdd = manualTotal;
        } else {
            pointsToAdd = currentBase + bonus;
        }

        // Antes de adicionar, subtrai a pontuação antiga daquela semana para a tribo
        // Isso permite editar a pontuação na mesma semana
        const oldScore = tribes[selectedTribeId].weeklyScores[currentWeekNumber - 1];
        tribes[selectedTribeId].weeklyScores[currentWeekNumber - 1] -= oldScore;
        
        // Adiciona os novos pontos
        tribes[selectedTribeId].weeklyScores[currentWeekNumber - 1] += pointsToAdd;
        
        saveStateToLocalStorage();
        updateTribeDisplays();
        updateRanking();

        // Envia para o Google Apps Script
        await fetch(WEB_APP_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'salvarDiario', // INDICA AÇÃO DE SALVAR LANÇAMENTO DIÁRIO
                tribe: tribes[selectedTribeId].nameDisplay,
                score: pointsToAdd,
                bonus: bonus,
                manualTotal: manualTotal,
                week: `Semana ${currentWeekNumber}`,
                date: new Date().toLocaleDateString('pt-BR'),
                time: new Date().toLocaleTimeString('pt-BR'),
                details: JSON.stringify(dailyMissionInputValues) // Envia os detalhes das missões como uma string JSON
            }),
        });
        console.log('Dados diários enviados para o Apps Script para', tribes[selectedTribeId].nameDisplay, ':', {
            action: 'salvarDiario',
            tribe: tribes[selectedTribeId].nameDisplay,
            score: pointsToAdd,
            bonus: bonus,
            manualTotal: manualTotal,
            week: `Semana ${currentWeekNumber}`,
            date: new Date().toLocaleDateString('pt-BR'),
            time: new Date().toLocaleTimeString('pt-BR'),
            details: JSON.stringify(dailyMissionInputValues)
        });
        alert(`Pontuação para ${tribes[selectedTribeId].nameDisplay} atribuída e enviada para a aba 'Lançamentos Diários'!`);

        // Reseta os inputs de missão diária somente após o salvamento de uma tribo
        // e prepara para a próxima atribuição.
        resetDailyMissionInputs();
        populateTribeSelector(); // Recarrega o seletor de tribos
        showDailyMissions(); // Volta para a seção de missões diárias, limpando inputs e mantendo a semana
    }

    function clearSelectedTribeInputs() {
        document.getElementById('tribe-selector').value = "";
        document.getElementById('selected-tribe-inputs').classList.add('hidden');
        document.getElementById('tribe_bonus').value = 0;
        document.getElementById('tribe_total_manual').value = 0;
        populateTribeSelector();
    }

    function resetDailyMissionInputs() {
        document.getElementById('segunda').value = 0;
        document.getElementById('terca').value = 0;
        document.getElementById('quarta_outros').value = 0;
        document.getElementById('quarta_principal').value = 0;
        document.getElementById('quinta').value = 0;
        document.getElementById('sabado').value = 0;
        document.getElementById('ej_novo').value = 0;
        document.getElementById('ej_afastado').value = 0;
        document.getElementById('domingo_150').value = 0;
        document.getElementById('domingo_75').value = 0;
        document.getElementById('manutencao_templo').value = 0;
        document.getElementById('resma_papel').value = 0;
        document.getElementById('time_futebol').value = 0;
        document.getElementById('evangelizacao_criativa').value = 0;
        document.getElementById('ponto_oracao').value = 0;

        for (const key in dailyMissionInputValues) {
            if (Object.prototype.hasOwnProperty.call(dailyMissionInputValues, key)) {
                dailyMissionInputValues[key] = 0;
            }
        }
        dailyBasePoints = 0;
        document.getElementById('dailyBaseDisplay').innerText = 0;
    }

    // --- Reset All Data (with confirmation) ---
    function confirmResetAllData() {
        const confirmText = "Tem certeza que quer zerar TODOS os dados LOCAIS do Rally? As pontuações semanais de TODAS as tribos e a semana atual serão apagadas! OS DADOS JÁ ENVIADOS PARA A PLANILHA GOOGLE NÃO SERÃO APAGADOS.";
        const confirmReset = confirm(confirmText);

        if (confirmReset) {
            resetAllDataLogic();
        } else {
            alert("A operação de reinício foi cancelada.");
        }
    }

    function resetAllDataLogic() {
        for (const tribeId in tribes) {
            tribes[tribeId].weeklyScores = Array(TOTAL_WEEKS).fill(0);
        }
        weekStatus.fill(false); // Reseta todos os status de semana para não finalizada
        currentWeekNumber = 1;

        saveStateToLocalStorage();
        showDailyMissions(); // Volta para a visualização padrão e reseta inputs
        updateTribeDisplays(); // Reseta pontuações exibidas
        updateRanking(); // Atualiza ranking com zeros
        updateWeekSelector(); // Reseta seletor de semana para 1
        alert("Rally Reiniciado! Todas as pontuações locais e semana resetadas.");
    }

    // --- Functions for Display and Ranking Updates ---
    function updateTribeDisplays() {
        const totalScores = {};
        for (const tribeId in tribes) {
            totalScores[tribeId] = tribes[tribeId].weeklyScores.reduce((sum, score) => sum + score, 0);
        }
        document.getElementById('score_levi').innerText = totalScores.levi;
        document.getElementById('score_juda').innerText = totalScores.juda;
        document.getElementById('score_naftali').innerText = totalScores.naftali;
        document.getElementById('score_gade').innerText = totalScores.gade;
    }

    function updateRanking() {
        const sortedTribes = Object.keys(tribes)
            .filter(key => Object.prototype.hasOwnProperty.call(tribes, key))
            .map(key => ({
                name: tribes[key].nameDisplay,
                score: tribes[key].weeklyScores.reduce((sum, score) => sum + score, 0),
                id: key,
                logo: tribes[key].logo
            }))
            .sort((a, b) => b.score - a.score);

        const rankingList = document.getElementById('tribes_ranking');
        rankingList.innerHTML = '';

        sortedTribes.forEach((tribe, index) => {
            const listItem = document.createElement('li');
            let trophy = '';
            if (index === 0) {
                trophy = '&#x1F3C6;';
            } else if (index === 1) {
                trophy = '&#x1F948;';
            } else if (index === 2) {
                trophy = '&#x1F949;';
            } else if (index === 3) {
                trophy = '&#x1F3C5;';
            }
            listItem.innerHTML = `<span class="trophy">${trophy}</span> <span class="tribe-rank-name-group"><img src="${tribe.logo}" alt="Logo ${tribe.name}" class="tribe-icon"><span class="tribe-name-text">${index + 1}º ${tribe.name}</span></span> <span class="tribe-rank-score">${tribe.score}</span>`;
            rankingList.appendChild(listItem);
        });

        const leaderNameSpan = document.getElementById('leaderName');
        if (sortedTribes.length > 0 && sortedTribes[0].score > 0) {
            const leaderTribe = sortedTribes[0];
            leaderNameSpan.innerHTML = `<img src="${leaderTribe.logo}" alt="Logo Líder" class="leader-icon"><span class="leader-text">${leaderTribe.name}</span>`;
        } else {
            leaderNameSpan.innerHTML = '<span class="leader-text">Nenhuma tribo pontuada</span>';
        }
    }

    function updateHistoryDisplay() {
        const historyTable = document.getElementById('history-table');
        const thead = historyTable.querySelector('thead');
        const tbody = historyTable.querySelector('tbody');
        const tfoot = historyTable.querySelector('tfoot');

        thead.innerHTML = '';
        tbody.innerHTML = '';
        tfoot.innerHTML = '';

        let headerRow = '<tr><th>Tribo</th>';
        for (let i = 1; i <= TOTAL_WEEKS; i++) {
            headerRow += `<th>Semana ${i}</th>`;
        }
        headerRow += '<th>Total Geral</th></tr>';
        thead.innerHTML = headerRow;

        for (const tribeId in tribes) {
            const tribe = tribes[tribeId];
            let row = `<tr><td><img src="${tribe.logo}" alt="Logo ${tribe.nameDisplay}" class="tribe-icon"> ${tribe.nameDisplay}</td>`;
            let tribeTotal = 0;
            for (let i = 0; i < TOTAL_WEEKS; i++) {
                row += `<td>${tribe.weeklyScores[i]}</td>`;
                tribeTotal += tribe.weeklyScores[i];
            }
            row += `<td>${tribeTotal}</td></tr>`;
            tbody.innerHTML += row;
        }

        let footerRow = '<tr class="history-total-row"><td>TOTAL GERAL</td>';
        let grandTotalsPerWeek = Array(TOTAL_WEEKS).fill(0);
        let finalGrandTotal = 0;

        for (let i = 0; i < TOTAL_WEEKS; i++) {
            for (const tribeId in tribes) {
                grandTotalsPerWeek[i] += tribes[tribeId].weeklyScores[i];
            }
            footerRow += `<td>${grandTotalsPerWeek[i]}</td>`;
            finalGrandTotal += grandTotalsPerWeek[i];
        }
        footerRow += `<td>${finalGrandTotal}</td></tr>`;
        tfoot.innerHTML = footerRow;
    }


    function getRandomColor() {
        const colors = [
            '#FFC107', /* Amarelo Destaque */
            '#28A745', /* Verde Destaque */
            '#007BFF', /* Azul Claro */
            '#FFFFFF', /* Branco */
            '#FF4500', /* Vermelho-Alaranjado para pop */
            '#9932CC'  /* Roxo Médio para variedade */
        ];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    // --- Core Logic for Ending Week ---
    function confirmEndWeek() {
        const confirmText = `Você tem certeza que deseja FINALIZAR a Semana ${currentWeekNumber}?\n\nIsso salvará a pontuação TOTAL de todas as tribos para esta semana na planilha e avançará para a próxima semana.\n\nESTA AÇÃO NÃO PODE SER DESFEITA FACILMENTE NA PLANILHA.`;
        const confirmEnd = confirm(confirmText); // Pede confirmação ao usuário

        if (confirmEnd) {
            endWeek(); // Se o usuário confirmar, chama a função para finalizar
        } else {
            alert("A finalização da semana foi cancelada.");
        }
    }

    async function endWeek() {
        // Marca a semana atual como finalizada
        weekStatus[currentWeekNumber - 1] = true;
        saveStateToLocalStorage(); // Salva o novo status da semana

        // Prepara os dados totais da semana para cada tribo para enviar
        const dadosSemanaisParaEnvio = Object.keys(tribes).map(tribeId => {
            return {
                semana: `Semana ${currentWeekNumber}`, // Ex: "Semana 1"
                nome: tribes[tribeId].nameDisplay,
                pontuacaoTotalSemana: tribes[tribeId].weeklyScores[currentWeekNumber - 1] // Pega a pontuação da semana atual
            };
        });

        // Envia esses dados para o Google Apps Script
        try {
            const response = await fetch(WEB_APP_URL, {
                method: 'POST', // Estamos enviando dados
                mode: 'no-cors', // Importante para Apps Script
                headers: { 'Content-Type': 'application/json' },
                // O corpo da requisição JSON. Note a propriedade 'action' e 'dadosSemanais'
                body: JSON.stringify({
                    action: 'salvarSemanal', // Diz ao Apps Script que é uma ação de salvar semanal
                    dadosSemanais: dadosSemanaisParaEnvio
                }),
            });
            console.log('Dados semanais enviados para o Apps Script:', dadosSemanaisParaEnvio);
            alert(`Pontuação da Semana ${currentWeekNumber} salva com sucesso na aba 'Pontuação Semanal' na sua planilha!`);

            // Após salvar, avança para a próxima semana no seu site
            if (currentWeekNumber < TOTAL_WEEKS) {
                currentWeekNumber++; // Incrementa o número da semana
                // Não há necessidade de resetar processedInCurrentRound aqui, pois ele foi removido dos tribes
                saveStateToLocalStorage(); // Salva o novo número da semana no seu navegador
                resetDailyMissionInputs(); // Limpa os inputs diários
                showDailyMissions(); // Volta para a tela principal de missões diárias
                updateWeekSelector(); // Atualiza o seletor de semana para a nova semana
                alert(`Avançado para a Semana ${currentWeekNumber}.`);
            } else {
                alert("Todas as semanas foram concluídas! O Rally terminou. Verifique o Campeão Final!");
                // Você pode adicionar aqui uma chamada para toggleChampionAnimation() se quiser que a animação apareça automaticamente ao final do rally.
            }

        } catch (error) {
            console.error('Erro ao enviar pontuação semanal para a planilha:', error);
            alert("Erro ao salvar a pontuação semanal. Verifique o console (F12) ou o URL do seu Apps Script.");
        }
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        loadStateFromLocalStorage();
        updateWeekSelector();
        calculateDailyBase('segunda'); // Calcula a pontuação base inicial (0)
        updateTribeDisplays();
        updateRanking();
        populateTribeSelector();
        showDailyMissions();
    });
</script>

</body>
</html>